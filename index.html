<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Redirecting...</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; text-align: center; }
  </style>
</head>
<body>
  <p>ðŸ”„ Redirecting, please wait...</p>

<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const code = new URLSearchParams(location.search).get("code");
if (!code) {
  document.body.innerHTML = "Invalid link";
}

db.ref("links/" + code).once("value").then(snap => {
  const data = snap.val();
  if (!data) return document.body.innerHTML = "Link not found";

  if (Date.now() > data.expires) {
    db.ref("links/" + code).remove();
    return document.body.innerHTML = "Link expired";
  }

  if (data.password) {
    const p = prompt("Enter password");
    if (p !== data.password) return alert("Wrong password");
  }

  db.ref("links/" + code + "/clicks").transaction(c => (c || 0) + 1);
  db.ref("logs/" + code).push({
    time: Date.now(),
    device: /Mobi/.test(navigator.userAgent) ? "mobile" : "desktop"
  });

  location.href = data.url;
});
</script>

</body>
</html>
